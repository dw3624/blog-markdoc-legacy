{"pageProps":{"markdoc":{"content":{"$$mdtype":"Tag","name":"article","attributes":{},"children":[{"$$mdtype":"Tag","name":"Heading","attributes":{"level":1,"id":"pythonanywhere-화재발생현황-저장하고-이메일로-전송"},"children":["PythonAnywhere 화재발생현황 저장하고 이메일로 전송"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"개요"},"children":["개요"]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":[{"$$mdtype":"Tag","name":"a","attributes":{"href":"https://nfds.go.kr/dashboard/monitor.do"},"children":["국가화재정보시스템"]},"이 제공하는 화재발생현황는 날짜가 바뀌면 전날 데이터를 볼 수 없음. 이에 매일 정해진 시간에 자동으로 데이터를 저장, 전송하는 웹앱을 작성함."]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":["크롤링 및 메일 전송 코드는 Python으로 작성함. 크롤링한 데이터는 excel로 변환해 xlsx 형태로 저장 후 메일 첨부해 전송. Python 코드상으로 gmail 로그인시 403 Forbidden 문제 발생. google 2단계인증 후 앱 비밀번호 이용. (참고 : https://support.google.com/mail/answer/14257, https://gomest.tistory.com/31)"]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":["호스팅은 PythonAnywhere를 사용. 무료계정이 접근할 수 있는 사이트가 제한돼있어 유료 플랜($5/달)으로 업그레이드. (참고 : https://help.pythonanywhere.com/pages/403ForbiddenError/)"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"목표"},"children":["목표"]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":["매일 23:57에 ",{"$$mdtype":"Tag","name":"a","attributes":{"href":"https://nfds.go.kr/dashboard/monitor.do"},"children":["국가화재정보시스템"]},"의 화재발생현황(서울, 경기)을 크롤링, 엑셀로 만든 뒤 특정 사용자에게 이메일로 전송하기"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"pythonanywhere"},"children":["PythonAnywhere"]},{"$$mdtype":"Tag","name":"ul","attributes":{},"children":[{"$$mdtype":"Tag","name":"li","attributes":{},"children":["Python으로 작성한 Web 프로그램을 배포해주는 무료호스팅 서비스"]}]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"코드"},"children":["코드"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":3,"id":"메일전송"},"children":["메일전송"]},{"$$mdtype":"Tag","name":"Fence","attributes":{"data-language":"python"},"children":["import smtplib, ssl\nfrom email.header import Header\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.application import MIMEApplication\n\n\n# SMTP認証情報\naccount = \"sobanghz@gmail.com\"\npassword = \"salzgpbgrbrzlrsd\"\n\n# 送受信先\nto_email = \"dw3624@gmail.com, monica0797@naver.com\"\nfrom_email = \"sobanghz@gmail.com\"\n\n\n# MIMEの作成\nmsg = MIMEMultipart()\n\nsubject = '화재발생현황'\nmsg[\"Subject\"] = Header(subject, charset='utf-8')\nmsg[\"To\"] = to_email\nmsg[\"From\"] = from_email\n\nmessage = f'{date_ymdhm} 기준 화재발생 현황입니다.'\nbody = MIMEText(message, _charset='utf-8')\nmsg.attach(body)\n\n# 파일첨부\nfile = f'{date_ymdhm}.xlsx'\nwith open(file, 'rb') as fd:\n    part = MIMEApplication(fd.read())\n    part.add_header('Content-Disposition','attachment',filename=file)\n    msg.attach(part)\n\nserver = smtplib.SMTP_SSL(\"smtp.gmail.com\", 465, context=ssl.create_default_context())\nserver.login(account, password)\nserver.send_message(msg)\nserver.quit()\nprint('mail sent!')\n"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":3,"id":"크롤링"},"children":["크롤링"]},{"$$mdtype":"Tag","name":"Fence","attributes":{"data-language":"python"},"children":["import requests\nimport pandas as pd\nimport json\n\n\nimport pytz\nfrom datetime import datetime\nKST = pytz.timezone('Asia/Seoul')\ndate_ymdhm = datetime.now(KST).strftime('%Y-%m-%d_%H시%M분')\nprint(date_ymdhm)\n\n\nurl = 'https://nfds.go.kr/dashboard/monitorData.do'\nproxyDict = {\n    'http'  : \"add http proxy\",\n    'https' : \"add https proxy\"\n}\n\n# 서울\npayload = {'sidoCode': '11'}\nres_su = requests.post(url, data=payload)\nresult_su = json.loads(res_su.text)\n\n# 경기\npayload = {'sidoCode': '41'}\nres_gg = requests.post(url, data=payload)\nresult_gg = json.loads(res_gg.text)\n\n# 서울 + 경기\ndf_su = pd.DataFrame(result_su['defail'])\ndf_gg = pd.DataFrame(result_gg['defail'])\ndf_sg = pd.concat([df_su, df_gg])\n\n# 정렬\ndf_sg = df_sg[[\n    'sidoNm', 'cntrNm', 'overDate',\n    'dethNum', 'injuNum', 'expMount',\n    'addr', 'progressNm', 'frfalTypeCd',\n]]\ndf_sg.columns = [\n    '지역','소방서','일시',\n    '사망','부상','재산피해(천원)',\n    '주소','진행','결과'\n]\ndf_sg = df_sg.sort_values('일시', ascending=False)\n\n# 엑셀 저장\ndf_sg.to_excel(f'{date_ymdhm}.xlsx', encoding='utf-8-sig', index=False)\nprint('excel saved!')\n"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":3,"id":"전체-코드"},"children":["전체 코드"]},{"$$mdtype":"Tag","name":"Fence","attributes":{"data-language":"python"},"children":["import requests\nimport pandas as pd\nimport json\n\nimport smtplib, ssl\nfrom email.header import Header\nfrom email.mime.text import MIMEText\nfrom email.mime.multipart import MIMEMultipart\nfrom email.mime.application import MIMEApplication\n\nimport pytz\nfrom datetime import datetime\nKST = pytz.timezone('Asia/Seoul')\ndate_ymdhm = datetime.now(KST).strftime('%Y-%m-%d_%H시%M분')\nprint(date_ymdhm)\n\n# SMTP認証情報\naccount = \"sobanghz@gmail.com\"\npassword = \"salzgpbgrbrzlrsd\"\n\n# 送受信先\nto_email = \"dw3624@gmail.com, monica0797@naver.com\"\nfrom_email = \"sobanghz@gmail.com\"\n\n\n##################### 크롤링코드 ###################################\nurl = 'https://nfds.go.kr/dashboard/monitorData.do'\nproxyDict = {\n    'http'  : \"add http proxy\",\n    'https' : \"add https proxy\"\n}\n\n# 서울\npayload = {'sidoCode': '11'}\nres_su = requests.post(url, data=payload)\nresult_su = json.loads(res_su.text)\n\n# 경기\npayload = {'sidoCode': '41'}\nres_gg = requests.post(url, data=payload)\nresult_gg = json.loads(res_gg.text)\n\n# 서울 + 경기\ndf_su = pd.DataFrame(result_su['defail'])\ndf_gg = pd.DataFrame(result_gg['defail'])\ndf_sg = pd.concat([df_su, df_gg])\n\n# 정렬\ndf_sg = df_sg[[\n    'sidoNm', 'cntrNm', 'overDate',\n    'dethNum', 'injuNum', 'expMount',\n    'addr', 'progressNm', 'frfalTypeCd',\n]]\ndf_sg.columns = [\n    '지역','소방서','일시',\n    '사망','부상','재산피해(천원)',\n    '주소','진행','결과'\n]\ndf_sg = df_sg.sort_values('일시', ascending=False)\n\n# 엑셀 저장\ndf_sg.to_excel(f'{date_ymdhm}.xlsx', encoding='utf-8-sig', index=False)\nprint('excel saved!')\n\n##################################################################\n\n# MIMEの作成\nmsg = MIMEMultipart()\n\nsubject = '화재발생현황'\nmsg[\"Subject\"] = Header(subject, charset='utf-8')\nmsg[\"To\"] = to_email\nmsg[\"From\"] = from_email\n\nmessage = f'{date_ymdhm} 기준 화재발생 현황입니다.'\nbody = MIMEText(message, _charset='utf-8')\nmsg.attach(body)\n\n# 파일첨부\nfile = f'{date_ymdhm}.xlsx'\nwith open(file, 'rb') as fd:\n    part = MIMEApplication(fd.read())\n    part.add_header('Content-Disposition','attachment',filename=file)\n    msg.attach(part)\n\nserver = smtplib.SMTP_SSL(\"smtp.gmail.com\", 465, context=ssl.create_default_context())\nserver.login(account, password)\nserver.send_message(msg)\nserver.quit()\nprint('mail sent!')\n"]}]},"frontmatter":{"title":"PythonAnywhere 사용한 이메일봇 만들기","date":"2022-07-05","tags":"python"},"file":{"path":"/docs/220705-nfds-email-bot.md"}}},"__N_SSG":true}